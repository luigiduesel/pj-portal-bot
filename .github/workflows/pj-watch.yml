name: PJ Watch (alle Krankenhäuser)
on:
  schedule:
    - cron: "0,15,30,45 5-22 * * *"   # alle 15 Min, 07–24 Uhr (Sommerzeit UTC+2)
  workflow_dispatch:             # manuell startbar

concurrency:
  group: pj-watch
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 6           # harter Cut: nach 6 Min abbrechen
    
    steps:
      - name: Docker-Image vorab ziehen (einmal pro Run)
        run: docker pull madrhr/pjportalbot:latest
        
      - name: Prüfe alle Krankenhäuser nacheinander (Einmal-Check)
        env:
          PUSHOVER_USER: ${{ secrets.pushover_user }}
          PUSHOVER_TOKEN: ${{ secrets.pushover_token }}
          PJ_USER: ${{ secrets.pjportal_user }}
          PJ_PWD: ${{ secrets.pjportal_pwd }}
          AJAX_UID: ${{ secrets.ajax_uid }}
          PJ_TAG: ${{ secrets.pj_tag }}
          TERM: ${{ secrets.term }}
          HOSPITAL_LIST: ${{ secrets.hospital_list }}
        run: |
          set -euo pipefail
          
          if [ -z "${HOSPITAL_LIST//[$'\t\r\n ']/}" ]; then
            echo "ERROR: HOSPITAL_LIST ist leer."
            exit 1
          fi
          
          run_one() {
            local HOSP="$1"
            local CONTAINER_NAME="pj-$$-$RANDOM"
            
            echo "==> Check für: $HOSP"
            
            # Container im Hintergrund starten
            docker run -d --rm \
              --name "$CONTAINER_NAME" \
              -e pushover_user="$PUSHOVER_USER" \
              -e pushover_token="$PUSHOVER_TOKEN" \
              -e pjportal_user="$PJ_USER" \
              -e pjportal_pwd="$PJ_PWD" \
              -e ajax_uid="$AJAX_UID" \
              -e pj_tag="$PJ_TAG" \
              -e hospital="$HOSP" \
              -e term="$TERM" \
              -e check_frequency_lower_limit="0" \
              -e check_frequency_upper_limit="0" \
              -e cookie_filepath="/usr/src/app/cookie.txt" \
              madrhr/pjportalbot:latest > /dev/null
            
            # Nur 3 Sekunden warten - der Check dauert nur 1-2 Sekunden
            sleep 3
            
            # Logs ausgeben (nur die relevanten Zeilen)
            docker logs "$CONTAINER_NAME" 2>&1 | grep -E "(Script completed|Nothing found|FOUND|ERROR)" || true
            
            # Container SOFORT stoppen und entfernen
            docker kill "$CONTAINER_NAME" > /dev/null 2>&1 || true
            docker rm -f "$CONTAINER_NAME" > /dev/null 2>&1 || true
            
            echo "✓ Check abgeschlossen"
          }
          
          # Mehrzeiliges Secret zeilenweise verarbeiten
          while IFS= read -r line || [ -n "$line" ]; do
            H="$(echo "$line" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"
            [ -z "$H" ] && continue
            run_one "$H"
          done <<EOF
          ${HOSPITAL_LIST}
          EOF
          
          echo "========================================="
          echo "Alle Checks erledigt."
          echo "========================================="
          
          # Cleanup aller Container zur Sicherheit
          docker ps -q | xargs -r docker kill 2>/dev/null || true
          docker ps -aq | xargs -r docker rm -f 2>/dev/null || true
